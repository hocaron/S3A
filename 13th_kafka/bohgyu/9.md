# 9 카프카 SQL을 이용한 스트리밍 처리

## 9.1 KSQL의 등장배경
- 카프카가 등장했을 때, 카프카는 데이터 버스로 사용하고 카프카에 있는 데이터를 가공해서 다시 다른 스토리지나 데이터베이스에 저장해서 사용했었다.
  - 외부 스토리지로는 카멜, 스톰, 스파크, 스트리밍, 삼자 등이 사용됨
- 다른 메시지 큐와 비교했을 때, 카프카의 단점
  - 큐 라우팅 기능이 부실했음.
    - 큐 라우팅 : 특정 큐로 데이터가 들어왔을 때, 정해진 룰 또는 이 큐의 데이터를 처리해서 다른 큐로 전달하는 기능
    - 삼자가 여기에 사용됨.
    - 아래 그림에서도 볼 수 있듯이 삼자가 사용됨.

![](https://tech.kakao.com/files/kemi-stats.jpg)

- 케미 폴러(KEMI Poller) 를 통해 데이터를 수집하고, 컴퓨팅 머신의 사용량 정보를 카프카에 보냅니다. 
- 카프카에서는 큐 라우팅 기능이 부족하니, 삼자(samza)를 통해 큐 라우팅해준다. 왜? 분석할려고
- 그리고 데이터 저장하기 위해서, `시계열 데이터베이스(TSDB)` 에 저장해둡니다.
- 위와 같은 그림처럼, raw 데이터를 처리해서 기간과 용량에 따라 별도의 저장소를 가져가는 것을 `람다 아키텍처(Lambda Architecture)` 라고 합니다.

> `시계열 데이터베이스(TSDB)`는 시간 기반 데이터의 저장, 검색, 분석, 처리 및 관리를 목적으로 설계된 데이터베이스입니다. `시계열 데이터`는 시간에 따라 시간 정보와 함께 기록된 데이터를 의미합니다. 예를 들어 센서 데이터, 서버 로그, 주가 데이터 등이 시계열 데이터의 예시입니다.

람다 아키텍처의 장점
- 람다 아키텍처는 파이프라인을 통해 큰 어려움 없이 적절한 기술들을 연결해서 단기 데이터와 장기 데이터를 동시에 관리
- 병목이 생길 경우, 특정 컴포넌트만 증가시킨다. (스케일 아웃)
- 데이터 조회 영역에서 큰 어려움없이 단기/장기 데이터를 한번에 조회


람다 아키텍처의 단점
- 적절한 기술들을 연결한다가 단점. 왜? 너무 많은 기술들을 사용해야해서..
- 단기/장기 데이터를 별도로 관리해야해서 관리비용 증가

그래서 카파 아키텍처 등장~

## 9.2 KSQL과 카파 아키텍처
- `카파 아키텍처`란, 데이터의 크기나 기간에 관계없이 하나의 계산 프로그램을 사용하는 방식입니다. 
- `람다 아키텍처`와 가장 큰 차이점을 가지는 부분은, 장기 데이터를 계산해서 빨리 조회할 수 있도록 배치 작업을 써서 '장기 데이터를 따로 저장'하는 것이 아니라 장기 데이터 조회가 필요한 경우에 '계산'해서 결과를 그때그때 전달하는 것입니다.
- 단기 데이터는 아파치 스파크나 스톰을 통해 결과 데이터를 만들어내고, 장기 데이터는 하둡에 복사한 다음 맵리듀스나 스파크를 통해 결과를 만들어내는 형태입니다.
- 하지만 이 방법도 저장소가 필요한 것은 매한가지입니다. 단기 데이터는 카프카에 저장해도, 장기 데이터는 하둡 같은 저장소에 저장해둬야합니다. 

데이터를 가져오는 영역까지도 단순하게, 그리고 저장 기간에 관계없이 통합되게 만들면 어떨까? KSQL 등장~

그냥 카프카에다가 다 저장해두면 안돼? `KSQL` 등장~

## 9.3 KSQL 아키텍처
- KSQL은 서버와 클라이언트로 나뉩니다. (MySQL 처럼)
- KSQL 서버 : 쿼리를 받는 REST API 서버와 넘겨 받은 쿼리를 실행하는 KSQL 엔진 클래스로 구성
- KSQL 클라이언트 : 쿼리문을 API로 보내서 카프카 데이터에 접근

### 9.3.1 KSQL 서버
- 일반적인 데이터베이스처럼, 쿼리를 받아 분석해서 계획을 짜고 실행
- 논리 계획과 물리 계획을 작성할 때 필요한 테이블 메타 정보(컬럼 이름, 타입 등)은 별도의 저장소에 저장하는 것이 아니라, KSQL 서버의 메모리에 위치
- 필요한 경우, `ksql__commands` 라는 카프카 토픽에 저장하는 것이 일반적인 SQL 엔진과 KSQL 엔진의 차이점
- KSQL 인스턴스나 서버가 추가되었을 때, 메타 데이터를 클러스터 간에 복제하는 것이 아니라 이 토픽을 읽어서 자신의 메모리에 생성

### 9.3.2 KSQL 클라이언트
- KSQL 클라이언트는 MySQL 클라이언트처럼 SQL 문을 KSQL 서버에 전달하고 결과를 받는 툴
- KSQL 은 스트림을 처리하는 엔진이므로, 기존 SQL에서 지원하는 테이블 외에 연속된 정형화된 데이터를 의미하는 `스트림`이라는 데이터 모델도 제공
  - `테이블`은 이벤트에 따른 현재 상태를 나타냄. 따라서 변경 가능함.
  - `스트림`은 데이터가 계속 기록될 수 있지만, 변경될 수 없음.


