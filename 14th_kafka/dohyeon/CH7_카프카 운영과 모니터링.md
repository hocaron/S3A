# 1. 주키퍼 구성

주키퍼는 파티션, 브로커의 메타데이터를 저장하고 컨트롤러 서버를 선출한다.

최근부터는 카프카 내부에서 해당 역할을 수행할 수 있게 되어 운영 효율성을 높였다.

---

## 1.1 주키퍼 서버 수량

주키퍼는 쿼럼 구성을 기반으로 동작하여 홀수로 구성하는 것이 바람직하다. 최소 노드 수는 3이 권장된다.

3대로 구성하게 되면 과반수인 2를 충족할 수 있는 최대 1대의 서버 장애를 허용할 수 있다.

주키퍼를 5대로 구성한다면 2대의 서버 장애를 허용할 수 있다.

운영 환경의 카프카의 사용량이 높지 않고 카프카 클러스터의 중요도가 크게 높지 않다면 3대로 구성하는 것이 적합하다.

하지만 회사의 핵심 중앙 데이터 파이프라인으로써 주키퍼를 사용하거나, 카프카의 사용량이 낮지만 회사에서 매우 중요한 역할로 쓰인다면 5대로 구성하는 것이 좋다.

---

## 1.2 주키퍼 스펙

- 메모리 크기 : 4GB ~ 8GB
- 디스크 : 240GB ~ 480GB SSD
- Heap : 1GB ~ 2GB

이 권장된다. 주키퍼에 과하게 스펙을 투자할 필요는 없으며 트랜잭션, 스냅샷 로그를 디스크에 저장하는 경우가 잦은데 이를 위해 쓰기 성능이 좋은 SSD가 권장된다.

또한 주키퍼와 카프카에는 메타데이터 같이 작은 데이터를 주고 받기 때문에 네트워크 카드에 대한 스펙도 1G 이더넷 카드정도로 해도 충분하다.

---

## 1.3 주키퍼 분산 배치

주키퍼를 하나의 물리적 랙에 배치하는 것은 권장되지 않는다. 클라우드, 온프레미스 일 경우 주키퍼를 분산하여 배치하는 것이 적절한데

클라우드 환경에서 사용할 때는 가용 영역을 2~3개로 다르게 배치하여 운영하는 것이 안정성을 확보하기에 적합하다.

---

# 2. 카프카 구성

## 2.1 카프카 서버 수량

카프카는 쿼럼 방식의 구성이 필요하지 않는다. 따라서 반드시 홀수일 필요는 없지만 카프카에서 공식적으로 권장하는 리플리케이션 팩터 수인 3을 맞추기 위해선 최소 3대의 브로커가 필요하다. 따라서 최소의 비용으로 카프카를 운용하기에는 3대가 적합하다.

## 2.2 카프카 하드웨어

### CPU

카프카의 CPU 사용률은 주키퍼와 달리 높다. 프로듀서, 컨슈머의 처리량을 늘리기 위해 배치, 압축 기능을 적용하게 되는데 이 부분에서 리소스를 많이 사용하게 된다. 따라서 코어 수가 많은 CPU로 구성하는 것을 권장한다.

### Memory

메모리는 JVM힙 크기를 6GB를 요구하는게 일반적이므로 이보다 큰 용량을 필요로한다. 최소 32GB의 메모리를 구성하는 것이 안정적이다.

### Disk

카프카를 구동시키는 서버는 디스크 쓰기 작업이 그리 빠르지 않아도된다. 카프카는 로그 마지막에 순차적으로 쓰는 방식으로 로깅하기때문에 높은 처리량을 보장할 수 있다.

하지만 브로커 한대에 물리적 디스크를 사용하는 것이 아닌 여러 곳에 분산시켜 배치하는 것이 좋다.

### 카프카 배치

주키퍼와 마찬가지로 분산 배치를 수행해야한다.

---

# 3. 모니터링 시스템 구성

## JMX로 브로커들의 메트릭 정보를 확인하기

JMX는 자바 API로, MBean(Managed Bean)이라는 객체로 표현된다. 이를 사용하기 위해 브로커에서 JMX 포트를 오픈하고 프로메테우스, 그라파나, 익스포터를 활용하여 GUI형태로 볼 수 있도록 하는 것이 좋다.

- 참고로 프로메테우스의 모니터링 방식은 Push가 아닌 Pull방식이다. 따라서 모니터링하고자 하는 대상 서버에 자신의 메트릭을 보여줄 수 있는 익스포터가 필요하다.
  - 익스포터는 메트릭들을 프로메테우스가 인식할 수 있는 형태로 나타내는 에이전트이다.
  - 따라서 익프토터는 모든 브로커에 설치해야한다.
