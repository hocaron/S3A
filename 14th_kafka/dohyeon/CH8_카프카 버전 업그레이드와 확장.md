# 1. 브로커 버전 업그레이드

# 1.1 카프카 버전 확인

```shell
cd /usr/local/kafka/bin/
kafka-topics.sh --version
```

위 명령어를 통해 현재 카프카 버전을 확인할 수 있다.

---

# 1.2 카프카 버전 업그레이드 시 주의할 점

```properties
inter.broker.protocol.version=2.1
log.message.format.version=2.1
```

카프카에는 설정 정보에 대한 properties를 지정해줄 수 있는데 위 옵션은 2.1 버전을 기반으로 브로커 간 내부 통신을 수행하겠다는 옵션이다.

즉, 2.6으로 업그레이드 해도 해당 브로커에 명시한 속성은 2.1버전이므로 다른 2.1버전의 브로커들과 통신이 가능하게 된 것이다.

만약 2.6버전으로 업그레이드 했다고 2.6으로 바꾼 속성으로 적용하게 되면 다른 2.1버전의 브로커들과 통신이 불가능해진다.

---

# 1.3 브로커의 카프카 버전 업그레이드

브로커 버전은 한 대씩 순차적으로 진행해야한다.

한 대씩 접근하여 카프카를 종료한 후 kafka 명령어를 사용하기 위한 심볼릭 링크를 새로 업그레이드한 버전으로 바꾼다.

`sudo ln -sf kafka_2.12-2.6.0 kafka`

---

## 1.4 브로커 설정 변경

버전 업데이트는 했지만 내부적으로 통신하는 프로토콜의 버전은 변경되지 않은 상태이다. 따라서 위에서 잠시 살펴보았던

```properties
inter.broker.protocol.version=2.1
log.message.format.version=2.1
```

위 옵션을 재설정하여 다시 반영시켜줘야한다.

위 옵션에 대한 내용을 지워서 기본값으로 적용되도록 하거나, 직접적으로 버전을 명시해주면된다.

그 이후 `sudo systemctl restart kafka-server`명령어로 해당 설정내용을 반영시키기 위해 재시작을 해준다.

---

# 2. 업그레이드 작업 시 주의사항

- 실제 운영환경에서는 위에서 살펴본대로 수월하게 업그레이드 진행되지 않을 확률이 높다. 따라서 개발 환경에서 충분한 테스트를 거친 후에 해당 시나리오대로 운영환경에 반영하는 것이 좋다.

- 또한, 카프카 사용량이 가장 적은 시간대에 업그레이드 작업을 수행하는 것이 권장되기도 한다.
  - 브로커를 한 대씩 종료시키면서 리플리케이션, 새로운 리더를 뽑는 과정 등이 수반되기에 카프카를 사용함에 있어서 지연시간이 늘어나게 되기 때문이다.

- 프로듀서의 `ack=1`옵션을 사용한다면 일부 메세지가 손실될 수도 있다. 따라서 프로듀서의 옵션 또한 고려하며 작업을 수행하는 것이 권장된다.

---

# 3. 카프카 확장 (브로커 추가)

클러스터에 브로커를 추가하기 위해선 카프카를 실행시키는 명령어를 기존 하던대로 하면된고,

`server.properties` 파일에 `broker.id`의 옵션을 고유한 옵션으로 새롭게 추가해주기만 하면된다.

**하지만 브로커를 추가했다고해서 토픽과 파티션들이 새로 추가된 브로커를 바라보고 있진 않게 된다.**

따라서 관리자가 토픽의 파티션들을 고르게 분산시켜줘야한다.

# 3.1 브로커 부하 분산

카프카에서 제공하는 `kafka-reassign-partitions.sh`이라는 쉘 스크립트를 활용하면 파티션을 재할당할 수 있다.

분산 작업은 다음 과정으로 수행된다.

1. 대상 토픽을 지정한다.
2. 토픽의 파티션들을 어떤 브로커로 분산시킬지 결정한다.
   3. 이 과정에서 