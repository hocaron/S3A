# 6장 컨슈머 오프셋 관리
- 컨슈머의 주요 역할은 **카프카에 저장된 메시지를 가져오는 것**이다.

<br/>

## 6.1 컨슈머 오프셋 관리
- 컨슈머가 **메시지를 어디까지 가져왔는지 표시**하는 것은 중요하다.
- 오프셋(offset)
  - 메시지의 위치를 나타내는 위치 (숫자 형태)
  - `_consumer_offsets` 토픽에 각 컨슈머 그룹별로 위치 정보가 기록된다.

<br/>

<img width="700" alt="image" src="https://github.com/mash-up-kr/S3A/assets/55437339/fe56cee7-f6d7-47ed-9f38-478daf4905bf">

🔼 컨슈머 기본 동작
- 컨슈머들은 지정된 토픽의 메시지를 읽은 뒤, 읽어온 위치와 오프셋 정보를 `_consumer_offsets`에 기록한다.
  - 오프셋값: 컨슈머가 다음으로 읽어야 할 위치
  - 1️⃣ 2번 오프셋 메시지 C까지 읽었다.
  - 2️⃣ 그 다음으로 읽어야 할 3번 오프셋 위치를 저장한다.
- 모든 컨슈머 그룹의 정보가 저장되는 `_consumer_offsets` 토픽은 파티션 수와 리플리케이션 팩터 수를 가진다.
  - offsets.topic.num.partitions: 기본값 50
  - offsets.topic.replication.factor: 기본값 3

<br/>

## 6.2 그룹 코디네이터
- 컨슈머 그룹 내의 각 컨슈머들은 서로 자신의 정보를 공유하면서 하나의 공동체로 동작한다.
- 컨슈머 그룹은 각 컨슈머들에게 작업을 균등하게 분배해야 한다. (컨슈머 리밸런싱 consumer rebalancing)
- 안정적인 컨슈머 그룹 관리를 위해 별도의 **코디네이터**가 존재한다. (그룹 코디네이터)
  - 컨슈머 그룹이 구독한 토픽의 파티션들과 그룹의 멤버들을 트래킹힌다.
  - 카프카 클러스터 내의 브로커 중 하나에 위치한다.
 
<br/>

<img width="500" alt="image" src="https://github.com/mash-up-kr/S3A/assets/55437339/43e9edd1-d508-4fb1-b303-c7ad6755ee22">

🔼 그룹 코디네이터의 컨슈머 그룹 관계
- 컨슈머 그룹이 브로커에 최초 연결 요청을 보내면 브로커 중 하나에 그룹 코디네이터가 생성된다.
- 그룹 코디네이터는 컨슈머 그룹의 컨슈머 변경과 구독하는 토픽 파티션 등에 대한 감지를 시작한다.
- 토픽의 파티션과 그룹의 멤버 변경이 일어나면 변경된 내용을 컨슈머들에게 알린다.

<br/>

<img width="811" alt="image" src="https://github.com/mash-up-kr/S3A/assets/55437339/80fd7f44-060c-445a-98ac-3b8e01f64ff0">

🔼 컨슈머 그룹 등록 과정
1. 컨슈머는 컨슈머 설정값 중에서 bootstrap.brokers 리스트에 있는 브로커에게 컨슈머 클라이언트와 초기 커넥션을 연결하기 위한 요청을 보낸다.
2. 해당 요청을 받은 브로커는 그룹 코디네이터를 생성하고 컨슈머에게 응답을 보낸다. (컨슈머 등록 전까지 아무 작업도 일어나지 않음)
3. 그룹 코디네이터는 group.initial.rebalance.delay.ms의 시간 동안 컨슈머의 요청을 기다린다.
4. 컨슈머는 컨슈머 등록 요청을 그룹 코디네이터에게 보낸다. 이때 가장 먼저 요청을 보내는 컨슈머가 컨슈머 그룹의 리더가 된다.
5. 컨슈머 등록 요청을 받은 그룹 코디네이터는 해당 컨슈머 그룹이 구독하는 토픽 파티션 리스트 등 리더 컨슈머의 요청에 응답을 보낸다.
6. 리더 컨슈머는 정해진 컨슈머 파티션 할당 전략에 따라 그룹 내 컨슈머들에게 파티션을 할당한 뒤 그룹 코디네이터에게 전달한다.
7. 그룹 코디네이터는 해당 정보를 캐시하고 각 그룹 내 컨슈머들에게 성공을 알린다.
8. 각 컨슈머들은 각자 지정된 토픽 파티션으로부터 메시지들을 가져온다.

<br/>

|컨슈머 옵션|값|설명|
|---|---|---|
|heartbeat.interval.ms|3000|- 기본값은 3000이며<br/>- 그룹 코디네이터와 하트비트 인터벌 시간<br/>- session.timeout.ms의 1/3이 적당하다.|
|session.timeout.ms|10000|- 기본값 10000<br/>- 어떤 컨슈머가 특정 시간 안에 하트비트를 받지 못하면 문제가 발생한다고 판단해 컨슈머 그룹에서 해당 컨슈머는 제거되고 리밸런싱 동작이 일어난다.|
|max.poll.interval.ms|300000|- 기본값 300000<br/>- 컨슈머는 주기적으로 poll()을 호출해 토픽으로부터 레코드를 가져오는데, 호출 후 최대 5분간 pll() 호출이 없다면 컨슈머가 문제 있는 것으로 판단해 리밸런싱 동작이 일어난다.|

🔼 컨슈머 하트비트 옵션
- 하트비트를 주기적으로 주고받으면서 그룹 코디네이터는 컨슈머가 잘 살아있는지, 잘 동작하는지 확인한다.
- 할당된 파티션에서 컨슈머가 정상적으로 메시지를 가져가고 있는지 poll() 동작 여부를 통해 확인할 수도 있다.
- 컨슈머의 다운을 너무 빠르게 감지하면 원치 않은 리밸런싱이 빈번하게 발생할 수 있고, 너무 느리게 감지하면 파티션의 메시지를 읽지 못하는 현상이 발생할 수 있다.

<br/>

## 6.3 스태틱 멤버십
