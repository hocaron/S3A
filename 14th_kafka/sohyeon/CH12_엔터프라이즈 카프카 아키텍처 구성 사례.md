# 12장 엔터프라이즈 카프카 아키텍처 구성 사례

## 12.1 엔터프라이즈용 카프카 아키텍처의 개요

<img alt="image" width="500" src="https://github.com/mash-up-kr/S3A/assets/55437339/d5cb2d14-8920-44d2-9e87-7760de57b257"/>

🔼 엔터프라이즈 환경에서 미러 메이커 사용 예제
- 카프카 간의 데이터 리플리케이션에는 주로 **미러 메이커**를 사용한다.
- (1) 업스트림 카프카와 다운스트림 카프카 사이에 리플리케이션이 필요한 경우이다.
- (2) 여러 데이터 센터마다 카프카가 존재하고 중앙에 있는 카프카로 데이터를 모으기 위해 리플리케이션을 사용하는 경우이다.

<br/>

<img alt="image" width="500" src="https://github.com/mash-up-kr/S3A/assets/55437339/c2cb52a3-611d-43ce-9d86-81a9c3f3ccf7"/>

🔼 엔터프라이즈 환경에서 카프카와 가장 많이 연동되어 쓰이는 애플리케이션들
- 중앙의 카프카 클러스터로 합쳐진 데이터는 실시간 처리와 분석을 위해 별도의 애플리케이션에 적재된다.
- 카프카와 연동해 많이 사용되는 예로 **장기 계획 배치**가 가능한 하둡, **실시간 검색**이 가능한 엘라스틱서치, AWS의 대표적인 **스토리지**인 S3, **빅데이터**를 실시간으로 읽고 쓸 수 있는 HBase 등이 있다.
- 각 애플리케이션마다 각기 다른 컨슈머가 필요하다. (for 카프카의 데이터를 적재하기 위한 토픽 컨슘)

<br/>

<img alt="image" width="500" src="https://github.com/mash-up-kr/S3A/assets/55437339/b1ba5afe-d99e-491a-8c5b-cd0fd5b9496c"/>

🔼 카프카 엔터프라이즈 환경 구성도
- 카프카 클러스터는 총 2개(업스트림 클러스터, 다운스트림 클러스터)로, **다운스트림 카프카는 업스트림 카프카를 미러링**한다.
- 카프카 간의 미러링을 위해 카프카 커넥트 기반의 **미러 메이커 2.0**이 동작한다.
- 양쪽의 카프카 클러스터는 효율적인 스키마 관리를 위해 **스키마 레지스트리**를 사용한다.
- 데이터의 흐름은 다음과 같다.
  - `프로듀서-1`이 업스트림 카프카로 메시지를 전송한다. (스키마 레지스트리 사용)
  - `컨슈머-1`은 업스트림 카프카로부터 메시지를 읽는다. (`프로듀서-1`과 동일한 스키마 레지스트리 이용)
  - `프로듀서-1`을 이용해 업스트림 카프카로 전송하는 메시지들은 미러 메이커 2.0을 통해 다운 스트림 카프카로 미러링된다.
  - 실시간 분석을 위해 `컨슈머-2`가 다운스트림 카프카로부터 메시지를 읽은 뒤 `엘라스틱서치`로 메시지를 전송한다.
    - 엘라스틱서치에서 제공하는 REST API 또는 `키바나`를 통해 관리자는 데이터를 확인할 수 있다.
   
- 관리 또는 모니터링 측면에서 업스트림 카프카와 다운스트림 카프카는 `CMAK`를 이용해 카프카의 토픽들을 관리할 수 있다.
  - 양쪽 카프카 클러스터들에서 발생하는 메트릭들이 `프로메테우스`에 저장된다.
  - 관리자는 `그라파나`를 통해 그래프 형태로 모니터링할 수 있다.
 
<br/>

## 12.2 엔터프라이즈용 카프카의 환경 구성

<img alt="image" width="500" src="https://github.com/mash-up-kr/S3A/assets/55437339/49151e89-c9dc-4c8a-ac20-b4fabf3534f5"/>

🔼 서버별로 실행되는 애플리케이션
- 필요한 애플리케이션은 다음과 같다.
  - 주키퍼
  - 카프카 클러스터 2개
  - 카프카 커넥트
  - 스키마 레지스트리
  - CMAK
  - 엘라스틱서치
  - 키바나
  - 모니터링 도구
 
- **주키퍼**는 1개의 앙상블만 구성하고, 지노드를 분리해 카프카 클러스터 2개가 하나의 주키퍼 앙상블을 바라보도록 구성한다.
- **카프카 커넥트**는 다운스트림 카프카와 같이 위치한다.
  - 미러링 동작은 프로듀서 + 컨슈머 동작으로 이뤄진다.
  - 업스트림과 함께 위치할 경우, 프로듀서가 메시지 전송 시 네트워크 장애 상황에 노출될 때 일부 메시지가 유실될 가능성이 높다.
  - 다운스트림과 함께 위치할 경우, 다운스트림으로 전송하는 프로듀서는 로컬 네트워크 환경에서 동작하므로 네트워크 관련 장애는 거의 발생하지 않을 것이다.
  - **프로듀서는 컨슈머보다 네트워크 장애에 더욱 민감하므로 다운스트림 카프카와 가까운 위치에 배치하는 것이 중요**하다.
 
<br/>

```
cd kafka2/
cd chapter12/ansible_playbook
ansible-playbook -i hosts site.yml
ansible-playbook -i hosts exporter.yml
ansible-playbook -i hosts monitoring.yml
```
- 전체 애플리케이션을 설치한다.
- peter-ansible01 서버에 접속하여 깃허브 예제 파일을 다운로드해둔 경로로 이동 후 명령어를 실행한다.
  - `site.yml`: 주키퍼, 카프카, 스키마 레지스트리, 카프카 커넥트 등
  - `exporter.yml`: JMX, 노드, 카프카 익스포터 등
  - `monitoring.yml`: 그라파나, 프로메테우스 등
 
<br/>

## 12.3 엔터프라이즈용 카프카의 운영 실습

### 12.3.1 CMAK를 이용한 토픽 생성

1. CMAK와 카프카 클러스터 연동
   - `http://peter-kafka01.foo.bar:9000` 주소로 접근
   - Cluster 드롭다운 메뉴를 클릭해 Add Cluster 선택
   - 클러스터의 상세 정보 입력
     - `Cluster Name`: kafka-1(업스트림 카프카)
     - `Cluster Zookeeper Hosts`: peter-zk01.foo.bar:2181,peter-zk02.foo.bar:2181,peter-zk03.foo.bar:2181/kafka3
     - `Enable JMX Polling`: 활성화
    
   - SAVE 버튼을 눌러 설정 마무리
  
2. 같은 방식으로 카프카 클러스터 `kafka-2` 추가(연동)
   - `Cluster Name`: kafka-2(다운스트림 카프카)
   - `Cluster Zookeeper Hosts`: peter-zk01.foo.bar:2181,peter-zk02.foo.bar:2181,peter-zk03.foo.bar:2181/kafka4
  
3. kafka-1 클러스터에 토픽(실습용) 생성
   - Cluster > List > kafka-1을 클릭해 `kafka-1`의 메인 메뉴로 이동
   - 상단 메뉴 중 Topic을 클릭해 드롭다운 메뉴 중 Create를 선택해서 토픽 생성 메뉴로 진입 (CMAK의 토픽 생성 메뉴)
   - 토픽의 상세 옵션 설정
     - `Topic`: peter-avro01-kafka1
     - `Partitions`: 1
     - `Replication Factor`: 3
    
   - Create 클릭
  
<br/>

### 12.3.2 카프카 커넥트 설정
