# 11장. 진화하는 설계 의사결정

## 도메인 변경

### 핵심에서 일반으로

- 이전에 경쟁 우위로 간주했던 것이 모든 경쟁업체가 사용할 수 있는 상품이 된 경우

### 일반에서 핵심으로

- 상용 솔루션을 자체 구현으로 교체 해 그 기능을 성공적으로 구현해 다른 경쟁업체보다 경쟁 우위를 확보한 경우
- 좋은 예제로 아마존이 있음. 아마존은 서비스를 실행할 인프라가 필요해 인프라를 관리하는 방식을 재창조했고 나중에 이를 수익성 있는 비즈니스로 전환했음.

### 지원에서 일반으로

- 사내에서 사내 솔루션으로 구현한 기능에 더불어 더 고급 기능을 포함하는 오픈소스 프로젝트 등으로 변경되어 회사가 사내 솔루션을 버리고 오픈 소스 솔루션과 연동하는 경우

### 지원에서 핵심으로

- 회사에서 비용을 줄이거나 추가 수익을 창출하는 방식으로 지원 로직을 최적화 하는 방법을 찾는 경우. 이러한 전조 증상은 하위 도메인의 비즈니스 로직이 점점 더 복잡해지는 것임.

### 핵심에서 지원으로

- 하위 도메인의 복잡성이 정당화되지 않을 때 발생할 수 있다.
  - 복잡성에 비해 수익성이 없는 경우

### 일반에서 지원으로

- 지원에서 일반으로 전환된 경우처럼 연동한 오픈 소스 솔루션의 복잡성 대비 얻는 이점을 정당화 할 수 없는 경우 회사는 다시 사내 개발 솔루션으로 전환할 수 있음. 이런 경우 전환이 일어남.

## 전략적 설계 문제

- 하위 도메인 유형의 변경은 바운디드 컨텍스트에 직접적인 영향을 미치고 결과적으로 전략적 설계 의사결정에도 영향을 준다.
- 이러한 변경의 영향을 받는 또 다른 통합 패턴은 분리형 노선이다.
  - 지원 하위 도메인과 일반 하위 도메인에 이 패턴을 사용할 수 있다.
  - 하위 도메인이 핵심 하위 도메인으로 변형되는 경우 여러 팀에허 해당 기능을 복제할 수 없기에 해당 팀들은 그들의 솔루션을 이 핵심 하위 도메인과 연동할 수 밖에 없고, 핵심 하위 도메인은 한 팀에서만 구현되기에 사용자-제공자 관계가 가장 적합하다.
- 구현 전략의 관점에서 핵심 하위 도메인과 지원 하위 도메인은 구현 방법이 다르다.
  - 지원 하위 도메인은 외부 위탁이나 신규 입사자를 위한 훈련용 도구로 사용할 수 있다.
  - 핵심 하위 도메인은 도메인 지식의 원천에 가깝게 하기 위해 사내 개발해야 한다. 이같은 논리는 반대로도 작동한다.

## 전술적 설계 문제

- 하위 도메인의 유형 변경을 나타내는 주요 지표는 기존의 기술적 설계가 현재 비즈니스 요구사항을 지원할 수 없는 경우이다.
- 지원 하위 도메인이 핵심 하위 도메인이 되는 예로 돌아가보면 지원 하위 도메인은 비교적 단순한 디자인 패턴으로 구현하는데 시간이 지남에 따라 복잡한 규칙과 불변성이 비즈니스 로직에 추가되면 기존에 사용하던 디자인 패턴 위에 새로운 기능을 추가하는 것은 고통스러운 일이다. 이 **고통**이 중요한 신호이며, 비즈니스 도메인과 설계 의사결정을 재평가하기 위한 신호다.
- 구현 전략에 변화가 필요하다는 것은 두려운 것이 아니고 자연스러운 일이다.
- 비즈니스는 예측 불가능하며 모든 유형의 하위 도메인에 가장 정교한 디자인 패턴을 적용할 수 없다.

### 트랜잭션 스크립트에서 액티브 레코드로

- 트랜잭션 스크립트와 액티브 레코드는 모두 절차지향 스크립트를 사용한다. 이 둘의 차이는 자료구조를 모델링하는 방식에 있다. 액티브 레코드 패턴은 저장 장치에 매핑하면서 발생하는 복잡성을 자료구조를 사용해 캡슐화 한다. 결과적으로 트랜잭션 스크립트에서 데이터 작업이 어려워지면 그것을 액티브 레코드로 리팩터링하자.

### 액티브 레코드에서 도메인 모델로

- 액티브 레코드를 조작하는 비즈니스 로직이 점점 더 복잡해지고 불일치 및 중복 사례가 많아지면 도메인 모델 패턴으로 리팩터링하자.
  - 밸류 오브젝트를 식별해 불변 객체로 모델링할 수 있는 자료구조를 찾고 관련된 비즈니스 로직을 찾아 밸류 오브젝트의 일부로 만들자.
  - 자료구조를 분석하고 트랜잭션 경계를 찾아라.
  - 모든 상태 수정 비즈니스 로직이 그에 상응하는 객체의 경계 내부로 이동할 때 비즈니스 규칙과 불변성을 지속적으로 확인하기 위해 어떤 계층이 필요한지 검토하라. 그것은 애그리게이트의 좋은 후보다.
  - 애그리게이트 설계 원칙을 염두에 두고 가장 작은 트랜잭션 경계, 즉 강한 일관성을 유지하는 데 필요한 최소 데이터를 찾아라.
  - 각 애그리게이트에 대해 루트 또는 퍼블릭 인터페이스의 엔드포인트를 식별한다.

### 도메인 모델에서 이벤트 소싱 도메인 모델로

- 애그리게이트 경계가 적절하게 설계된 도메인 모델이 있으면 이벤트 소싱 모델로 전환할 수 있다.
- 애그리게이트의 데이터를 직접 수정하는 대신 애그리게이트의 수명주기를 나타내는 데 필요한 도메인 이벤트를 모델링한다.
- 도메인 모델을 이벤트 소싱 도메인 모델로 리팩터링할 때 가장 어려운 점은 기존 애그리게이트의 이력이므로 과거 이벤트를 생성하거나 마이그레이션 이벤트를 모델링해야 한다.

### 전환에 필요한 과거 이력 생성

- 각 애그리게이트를 위한 대략적인 이벤트 스트림을 생성해서, 변환된 모델이 생성된 이벤트 스트림을 프로젝션해서 원래 구현과 동일한 상태를 나타내게 한다.
- 이벤트 소싱을 사용하는 목표는 애그리게이트의 도메인 이벤트에 대해 안정적이고 강한 일관성을 가진 이력을 보유 하는 것인데 이 방식은 상태 전환의 전체 히스토리를 복구하는 것이 불가능하다.

### 마이그레이션 이벤트 모델링

- 위 방법의 대안으로 과거 이벤트에 대한 지식 부족을 인정하고, 명시적으로 이벤트를 모델링하는 방법이다.
- 현재 상태로 이어질 수 있는 모든 이벤트를 복구하는 대신 마이그레이션 이벤트를 정의하고 기존 애그리게이트 인스턴스의 이벤트 스트림을 초기화 한다.
- 장점은 과거 데이터의 부족함을 명확히 하는 것이다.
- 단점은 레거시 시스템의 흔적이 이벤트 스토어에 영원히 남는다는 것이다.

## 조직 변화

- 조직 구조의 변화는 팀 의사소통 및 협업 수준에 영향을 미치고 결과적으로 바운디드 컨텍스트를 통합하는 방식에 영향을 준다.
- 기존 바운디드 컨텍스트에 대한 작업이 다른 지역으로 이동하면 팀의 협업에 부정적인 영향을 줄 수 있어 바운디드 컨텍스트의 연동 패턴이 그에 맞게 진화해야 한다.

### 파트너십에서 사용자-제공자로

- 파트너십 패턴은 팀 간의 강력한 의사소통과 협업을 전제로 한다
- 시간이 지남에 따라 이런 전제가 없어질 경우 팀 의사소통에 부정적인 영향을 주며 파트너십 패턴에서 사용자-제공자 관계를 이동하는 것이 적절하다

### 사용자-제공자에서 분리형 노선으로

- 지리적 거리나 조직 내부 정치로 인해 팀에 심각한 의사소통 문제가 생기는 경우 팀은 시간이 지남에 따라 통합 문제를 겪게 되어 이 경우 기능을 복제하는 것이 더 효과적일 수 있다

## 도메인 지식

- 도메인 주도 설계의 핵심 신조는 성공적인 소프트웨어 시스템 설계하는 데 도메인 지식이 반드시 필요하다는 것이다
  - 핵심 하위 도메인은 로직이 복잡할 뿐 아니라 자주 변경된며 모델링은 지속적인 과정이다.
  - 비즈니스 도메인에 대한 더 많은 지식을 습득함에 따라 모델을 개선해야 한다
- 비즈니스 도메인의 복잡성은 잘 드러나지 않을 때가 많다
  - 처음에는 모든 것이 간단하고 쉬워 보여도 기능이 추가됨에 따라 점점 더 많은 엣지 케이스, 불변성, 규칙이 발견된다
- 전략적 설계 관점에서 볼 때 도메인 지식 수준에 따라 바운디드 컨텍스트의 경계를 설계하는 것은 유용한 휴리스틱이다
  - 시스템을 잘못된 바운디드 컨텍스트로 분해하면 시간이 지날수록 유지보수 비용이 증가한다
  - 도메인 로직이 불명확하고 자주 변경하는 경우 바운디드 컨텍스트를 더 넓은 경계로 설계하자
  - 시간이 지남에 따라 도메인 지식이 발견되고 비즈니스 로직의 변경사항이 안정화되면 넓은 바운디드 컨텍스트를 작은 바운디드 컨텍스트 또는 마이크로서비스로 분해할 수 있다
- 새로운 도메인 지식이 발견되면 이를 활용해 설계를 발전시키고 회복성을 높여야 한다

## 성장

- 성장은 시스템이 건강하다는 신호다.
  - 새로운 기능이 지속해서 추가된다는 것은 경쟁 제품에 뒤지지 않게 확장한다는 뜻이다.
  - 반대로 프로젝트가 성장함에 따라 해당 코드베이스는 커다란 진흙 덩어리로 성장할 수 있다.
- 커다란 진흙 덩어리를 초래하는 규제 없는 성장은 설계의 의사결정을 재평가하지 않고 소프트웨어 시스템의 기능을 확장한 결과다.
- 성장에 따른 복잡성을 다루는 기본 원칙은 우발적 복잡성 즉, 오래된 설계의 결정으로 발생하는 복잡성을 식별하고 제거하는 것이다.

→ 성장 중심의 복잡성을 다루기 위해 비즈니스 도메인과 전략적 구성요소를 분석하고 비즈니스 도메인과 관련된 모델을 설계한 후 코드에서 해당 모델을 설계하고 구현하는 프로세스를 적용해보자.

### 하위 도메인

- 하위 도메인의 경계는 식별하기 어려울 수 있으며, 결과적으로 유용한 경계를 찾기 위해 노력해야 한다.
- 비즈니스 도메인이 성장함에 따라 하위 도메인의 경계가 흐려질 수 있기에 여러 개로 세분화된 하위 도메인에 걸쳐있는 하위 도메인은 식별하기 어렵다.
  - 따라서 이미 식별된 하위 도메인을 다시 확인하고 응집된 유스케이스에서 휴리스틱을 활용해 하위 도메인을 나누는 지점을 다시 식별하는 것이 중요하다.
- 추출하고 명시적으로 만들 수 있는 내부 하위 도메인을 식별해 핵심 하위 도메인을 최대한 추출해야 한다.

### 바운디드 컨텍스트

- 바운디드 컨텍스트 패턴을 통해 비즈니스 도메인의 다양한 모델을 사용할 수 있다. 특정 문제 해결에 초점을 맞춘 모델을 만들 수 있다.
- 프로젝트가 발전하고 성장함에 따라 바운디드 컨텍스트가 초점을 잃고 우발적 복잡성이 추가될 수 있다.
  - 하위 도메인과 마찬가지로 경계를 때때로 다시 살펴보자.
  - 특정 문제를 해결하는 데 초점을 맞춘 바운디드 컨텍스트를 추출해 모델을 단순화할 수 있는 기회를 항상 찾아라
- 성장은 기존의 암시적 설계 문제를 명확하게 만들 수 있다.
  - 바운디드 컨텍스트가 다른 바운디드 컨텍스트를 호출하지 않고는 작업을 완료할 수 없을 경우 이는 비효율적인 모델의 강력한 신호이다.
  - 이때 바운디드 컨텍스트의 경계를 재설계해 각각의 자율성을 높여야 한다.

### 애그리게이트

- 경험상 애그리게이트는 가능한 한 작게 유지하고, 비즈니스 도메인에서 강력하게 일관적인 상태를 유지해야 하는 객체만 포함한다.
- 위의 원칙을 지키지 않고 이미 있는 애그리게이트에 새로운 기능을 배포하는 것이 편할 수 있다.
  - 비즈니스 로직에 따라 강력하게 일관성을 유지할 필요가 없는 데이터까지 포함되면서 커진다면 이는 제거해야 하는 우발적 복잡성이다.
- 비즈니스 기능을 전담 애그리게이트로 추출하면 원래 애그리게이트가 단순해질 뿐 아니라 잠재적으로 해당 애그리게이트가 속한 바운디드 컨텍스트도 단순해진다.
  - 이러한 리팩터링을 통해 일단 드러나면 또 하나의 바운디드 컨텍스트로 추출해야 할 숨겨진 모델이 발견될 때가 많다.

# 12. 이벤트스토밍

### 이벤트스토밍

- 사람들이 모여 비즈니스 프로세스에 관해 브레인스토밍하고 신속하게 모델링하기 위한 로우테크 활동이다.
  - 비즈니스 도메인 지식을 공유하기 위한 전술적 도구다.
- 참가자는 포스트잇을 활용하여 일련의 도메인 이벤트를 시간의 흐름에 따라 표현한다.
- 모델의 모든 구성요소가 비즈니스 프로세스의 작동 방식을 설명할 때까지 단계별로 액터, 커맨드, 외부 시스템 등의 개념을 모델에 추가하여 개선한다.

### 누가 이벤트스토밍에 참석하나?

- 다양한 배경을 가진 사람이 많이 참여할수록 더 많은 지식이 발견된다.
- 참가자의 규모가 너무 크지 않게 한다.
  - 10명 이상이 되면 모든 참가자가 과정에 기여하는 것이 어렵다.

### 이벤트스토밍에 무엇이 필요한가?

- 펜과 종이만 사용하기 때문에 로우테크 워크숍으로 간주된다.
- 모델링 공간, 포스트잇, 마커, 간식, 회의실 등 준비물이 필요하다.

### 이벤트스토밍 과정

10단계로 구성되며 각 단계마다 정보와 개념을 모델에 추가하여 모델을 풍성하게 한다.

- 1단계: 자유로운 탐색
  - 탐색하려는 비즈니스 도메인에 관련된 도메인 이벤트를 브레인스토밍하는 것으로 시작한다. 이미 발생한 일을 설명하므로 과거형으로 작성하는 것이 중요하다.
- 2단계: 타임라인
  - 생성된 도메인 이벤트를 읽어보고 그것을 비즈니스 도메인에서 발생하는 순서대로 정리한다.
  - 정상 시나리오부터 시작하여 다른 시나리오를 추가한다.
  - 중복을 제거한다.
- 3단계: 고충점
  - 전체 구성을 보고 프로세스에서 주목할 만한 포인트를 식별한다.
  - 이벤트스토밍 세션 과정에서 이런 포인트로 쉽게 돌아오거나 나중에 다시 다룰 수 있도록 비효과적인 것들을 명확하게 표시하는 것이 중요하다.
  - 이벤트스토밍의 전 과정에서 참가자의 코멘트에 주목하고 이슈나 관심사가 나오면 고충점으로 기록한다.
- 4단계: 중요 이벤트
  - 컨텍스트나 국면이 바뀌는 것을 나타내는 중대한 비즈니스 이벤트를 찾는다. 이를 중요 이벤트라고 한다.
  - 중요 이벤트는 향후 바운디드 컨텍스트의 후보가 된다.
- 5단계: 커맨드
  - 무엇이 이벤트 또는 이벤트의 흐름을 시작하게 하는지를 설명한다.
  - 시스템의 오퍼레이션을 설명하고 도메인 이벤트와는 반대로 명령형으로 작성한다.
- 6단계: 정책
  - 커맨드를 실행할 수도 있는 자동화 정책을 찾는다.
  - 자동화 정책은 이벤트가 커맨드의 실행을 시작하는 시나리오다. 커맨드는 특정 이벤트가 발생할 때 자동으로 실행된다.
- 7단계: 읽기 모델
  - 읽기 모델은 도메인에서 액터가 커맨드를 실행하는 의사결정을 내릴 때 사용하는 시각적 데이터다.
  - 액터의 의사결정을 돕는데 필요한 정보의 원천에 대해 짧게 설명한다.
  - 액터가 읽기 모델을 본 후에 커맨드를 실행하므로 모델링 공간에서 커맨드 앞에 읽기 모델을 둔다.
- 8단계: 외부 시스템
  - 외부 시스템 연동 정보를 보강한다. 탐색 중인 도메인에 포함되지 않는 모든 시스템이 외부 시스템에 해당한다.
  - 이 단계가 끝나면 모든 커맨드는 액터 또는 정책에 의해서 실행되거나 외부 시스템이 호출하여 실행된다.
- 9단계: 애그리게이트
  - 모든 이벤트와 커맨드가 표현되면 참가자는 애그리게이트의 개념을 포함하여 모델을 구성할 수 있다.
  - 애그리게이트는 커맨드를 받고 이벤트를 생성한다.
- 10단계: 바운디드 컨테스트
  - 서로 연관된 애그리게이트를 찾는다.

### 변형

- 위에 것들은 가이드다. 필요에 따라 바꿔서 진행해도 좋다.
- 큰 그림을 탐색하는 것은 중요하다. 회사의 비즈니스 도메인을 폭넓게 다루게 되고 유비쿼터스 언어를 구축하는 강력한 토대가 만들어지며, 바운디드 컨텍스트 경계의 윤곽을 그릴 수 있다.
- 이벤트스토밍의 가치는 다양한 이해관계자 간의 지식 공유, 비즈니스와 멘탈 모델의 일치, 충돌하는 모델의 발견, 유비쿼터스 언어를 구축하는 과정 그 자체에 있다.

### 이벤트스토밍을 사용하는 경우

- 다음과 같은 다양한 이유가 있다.
  - 유비쿼터스 언어 구축하기
  - 비즈니스 프로세스 모델링하기
  - 새로운 비즈니스 요구사항 탐색하기
  - 도메인 지식 복구하기
  - 존재하는 비즈니스 프로세스의 개선 방법 탐색하기
  - 새로운 팀원의 훈련

### 진행 팁

- 이벤트스토밍은 그룹 활동이며 모두가 참여하도록 해야한다.
- 원격으로 진행한다면 효율이 떨어진다. 오프라인보다 인원을 더 적게 가는 것이 좋다.
