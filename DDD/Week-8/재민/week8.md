# [DDD] 박재민 15~16장

# 15장. 이벤트 주도 아키텍처

- EDA(Event-Driven Architecture) 는 현대 분산 시스템 어디에서나 찾아볼 수 있다
    - 많은 살마이 느슨하게 결합되고, 확장 가능하며, 내결함성을 가진 분산 시스템을 설계할 때 이벤트 주도 커뮤니케이션을 기본 통합 매커니즘으로 사용할 것을 권고
- 이벤트 주도 아키텍처는 종종 도메인 주도 설계와 연결된다
- 이벤트는 레거시 시스템에 적용해 느슨하게 연결된 분산 시스템으로 전환할 수 있는 비법 소스가 아니다
    - EDA를 부주의하게 적용하면 모듈식 모놀리스를 분산된 커다란 진흙덩어리로 만들 수 있다

→ EDA와 DDD 사이의 상호작용을 탐구하고 이벤트 주도 아키텍처의 필수 구성요소와 실패한 EDA 프로젝트의 일반적 원인 및 DDD 도구를 활용하여 효과적인 비동기식 연동 시스템을 설계하는 방법을 배우자!

## 이벤트 주도 아키텍처

- 시스템 컴포넌트가 이벤트 메시지를 교환하면서 비동기적으로 서로 커뮤니케이션하는 아키텍처 스타일
    - 동기적으로 서비스의 엔드포인트를 호출하는게 아닌 컴포너트가 이벤트를 발행해 시스템 도메인의 변경사항을 다른 시스템 요소에 알리는 것
    - 해당 컴포넌트는 시스템에서 발생한 이벤트를 구독하고 그에 따라 반응한다
    - 이벤트 주도 실행 흐름의 일반적인 예로 사가 패턴이 있다
- 이벤트 주도 아키텍처와 이벤트 소싱의 차이점
    - EDA는 서비스 간 통신을 의미하지만 이벤트 소싱은 서비스 내부에서 발생
    - 이벤트 소싱을 위해 설계된 이벤트는 비즈니스 도메인의 복잡성을 파악하기 위해 서비스 내에서 구현된 상태 전환을 나타냄

---

## 이벤트

### 이벤트, 커맨드, 메시지

- 메시지에는 두 가지 유형이 있다
    - 이벤트 : 이미 발생한 변화를 설명하는 메시지
    - 커맨드 : 수행돼야 할 작업을 설명하는 메시지
- 이벤트는 이미 일어난 일이고 커맨드는 어떤 일을 하라는 지시이다
- 이벤트와 커맨드 모두 메시지로 비동기 통신할 수 있다
- 커맨드는 유효하지 않거나 시스템의 비즈니스 규칙과 모순되는 경우 거부될 수 있다
- 이벤트는 취소할 수 없다. 이벤트를 되돌리기 위해서는 사가 패턴에서 수행하는 커맨드인 보상 조치를 실행해야 한다

### 구조

- 이벤트는 선택한 메시징 플랫폼을 사용하여 직렬화하고 전송할 수 있는 데이터 레코드이다
- 일반적인 이벤트 스키마에는 이벤트의 메타데이터와 페이로드를 포함한다

### 이벤트 유형

- 이벤트는 이벤트 알림, 이벤트를 통한 상태 전송, 도메인 이벤트의 세 가지 유형 중 하나로 분류할 수 있다

**이벤트 알림**

- 다른 컴포넌트가 반응할 비즈니스 도메인의 변경에 관한 메시지다
- 이벤트 알림은 장황하지 않아야 하며 구독자가 이벤트에 반응하는데 필요한 모든 정보를 포함해서는 안 된다
- 보상: 수신자가 세부 정보를 얻기 위한 질의를 명시적으로 하도록 강제해 민감한 정보가 메시징 인프라를 통해 공유되는 것을 막고 구독자가 데이터에 접근하기 위한 추가 권한이 필요하게 한다
- 동시성: 비동기적인 특성상 구독자가 정보를 받았을 때 해당 정보가 만료된 상태일 수 있어 명시적인 질의를 통해 최신 상태를 얻을 수 있다

**이벤트를 통한 상태 전송**

- 구독자에게 제공자의 내부 상태에 대한 변경사항을 알려준다
- 이벤트 알림 메시지와 달리 상태 변경을 반영하는 모든 데이터를 포함한다
- 두 가지 형태로 나타낼 수 있다
    - 수정된 엔티티의 상태에 대한 완전한 스냅숏
    - 업데이트된 필드한 포함하는 경우
- 엔티티 상태의 로컬 캐시를 보유하고 이용할 수 있다
    - 비동기 데이터 복제 메커니즘이다
    - 시스템의 내결함성이 향상되므로 제공자 서비스가 가용하지 않은 경우라도 사용자는 계속 작업이 가능
    - 여러 소스의 데이터를 처리해야 하는 컴포넌트의 성능을 향상시킬 수 있다

**도메인 이벤트**

- 이벤트 알림과 ECST 메시지 사이 어딘가에 있다
    - 둘 다 비즈니스 도메인에서 중요한 이벤트를 설명하고, 관련된 모든 데이터를 포함한다

**도메인 이벤트와 이벤트 알림의 관계**

- 둘 모두 제공자의 비즈니스 도메인에서 발생한 변경사항을 설명한다
- 두 가지 차이점이 존재한다
    - 도메인 이벤트에는 이벤트를 설명하는 모든 정보를 포함한다
    - 모델링 의도가 다르다
        - 이벤트 알림은 다른 컴포넌트와의 연동을 돕기 위해 설계됨
        - 도메인 이벤트는 비즈니스 도메인을 모델링하고 설명하기 위함

**도메인 이벤트와 이벤트를 통한 상태 전송의 관계**

- 도메인 이벤트에 포함된 데이터는 일반적인 ECST 메시지의 스키마와 개념적으로 다르다
- ECST 메시지는 제공자 데이터를 로컬 캐시로 보유하기에 충분한 정보를 제공함
    - 반면 도메인 이벤트는 이러한 풍부한 모델을 노출해서는 안됨
    - 사용자가 구독하지 않은 다른 도메인 이벤트가 동일한 필드에 영향을 줄 수 있으므로 특정 도메인 이벤트에 포함된 데이터조차 애그리게이트의 상태를 캐싱하기엔 충분치 않다
- 두 가지 유형의 메시지에 대한 모델링 의도가 다르다
    - 도메인 이벤트에 포함된 데이터는 애그리게이트의 상태를 설명하기 위한 것이 아닌 수명 주기 동안 발생한 비즈니스 이벤트를 설명한다

---

## 이벤트 주도 연동 설계

- EDA 기반 시스템에서 이벤트는 컴포넌트가 연동하는 방식과 컴포넌트의 경계 자체에 모두 영향을 주는 가장 중요한 설계 요소다

→ 다양한 이벤트 유형을 적용하기 위한 휴리스틱을 학습해보자!

### 분산된 커다란 진흙 덩어리

[페이지 253을 참조]

이 시스템의 결합 유형을 분석해 보자

### 시간 결합

- 실행 순서가 있으며 5분의 지연시간이 있는 경우 5분의 지연 시간은 명백하게 잘못된 순서로 실행되는 것을 막지 못한다
    - 광고최적화가 과부하로 5분 이내에 처리되지 못할 수 있다
    - 네트워크 문제로 수신 메시지가 광고최적화 서비스로 전달되는 것이 지연될 수 있다
    - 광고최적화 컴포넌트가 중단돼서 수신 메시지 처리가 중단될 수 있다

### 기능 결합

- 마케팅과 광고최적화 BC 모두 CRM의 도메인 이벤트를 구독하고 동일하게 고객 데이터를 프로젝션하도록 구현함
    - 컴포넌트 중 하나에서 프로젝션 변경이 일어날 경우 두 번째 BC에서 변경사항을 복제해야 함
- 즉, 같은 비즈니스 기능을 구현하는 여러 컴포넌트가 있을 때 변경이 생기면 양쪽 컴포넌트에 동시에 반영해야 함

### 구현 결합

- 마케팅과 광고최적화 BC 모두 CRM의 이벤트 소싱 모델로 생성된 도메인 이벤트를 구독해 새 도메인 이벤트를 추가하거나 기존 이벤트의 스키마 변경 처럼 CRM 구현의 변경사항이 발생하면 이걸 구독하는 BC 모두 반영해야 한다

### 이벤트 주도 연동의 리팩터링

- 구현 결합
    - CRM 데이터 모델을 구성하는 모든 도메인 이벤트를 노출하면 구독자가 제공자의 구현 상세에 결합됨
    - 고로, 훨씬 더 제한된 이벤트 집합이나 다른 유형의 이벤트를 노출하여 해결
- 기능 결합
    - 마케팅과 광고 최적화 구독자는 같은 비즈니스 기능을 구현하여 기능적으로 서로 결합된다
    - CRM BC에서 프로젝션 로직을 캡슐화해 결합도를 낮출 수 있다 (OHS)
- 시간 결합
    - 광고최적화 컴포넌트가 이벤트 알림 메시지를 발행해 리포팅 컴포넌트가 필요한 데이터를 가져오도록 트리거할 수 있다

### 이벤트 주도 설계 휴리스틱

**최악의 상황을 가정하라**

- 앤드류 그로브의 EDA 원칙
    - 네트워크가 느려질 것이다
    - 가장 어렵거나 중요한 순간에 서버 장애가 발생한다
    - 이벤트가 순서대로 도착하지 않는다
    - 이벤트가 중복된다
- 이벤트가 항상 일관되게 전달되는 방법
    - 메시지를 안정적으로 발송하기 위해 아웃박스 패턴을 사용하자
    - 메시지를 발송할 때 구독자가 메시지 중복을 제거하고 순서가 잘못된 메시지를 식별하고 재정렬할 수 있게 하라
    - 보상 조치를 실행해야 하는 교차 BC 프로세스를 조율할 때 사가 패턴과 프로세스 관리자 패턴을 활용하라

**퍼블릭 이벤트와 프라이빗 이벤트를 사용하라**

- 이벤트 소싱 애그리게이트에서 도메인 이벤트를 발송할 때 세부 정보를 노출하지 않도록 주의하라
    - 이벤트를 BC의 퍼블릭 인터페이스의 내재된 부분으로 취급하라
    - 따라서 OHS를 구현할 때 이벤트가 BC의 공표된 언어에 반영되게 하라
- BC의 퍼블릭 인터페이스를 설계할 때 다른 유형의 이벤트를 활용하라
    - 이벤트를 통한 상태 전송 메시지는 구현 모델을 사용자가 필요로 하는 정보만 전달하는 더욱 간결한 모델로 압축
- 이벤트 알림 메시지를 사용해 퍼블릭 인터페이스를 더욱 최소화
- 외부 BC와 통신을 위한 도메인 이벤트를 최소화

**일관성 요구사항을 평가하라**

- BC의 일관성 요구사항을 평가하는 방법
    - 컴포넌트가 궁극적으로 일관된 데이터를 처리할 수 있는 경우 이벤트를 통한 상태 전송 메시지를 사용
    - 사용자가 제공자의 마지막으로 변경된 상태를 읽어야 하는 경우 제공자의 최신 상태를 가져오는 후속 질의와 함께 이벤트 알림 메시지를 발행

# 16장. 데이터 메시

- 실시간 데이터 처리 시스템은 시스템의 데이터를 조작하고 시스템 환경에서 일어나는 일상적인 작업을 조율하는 실시간 트랜잭션을 구현한는데 이 같은 모델이 OLTP 데이터다
- 적잘한 모델링을 해야 하는 주목해야 할 다른 유형의 데이터에는 OLAP가 있다

→ 분석 데이터 관리 아키텍처 즉, 데이터 메시에 대해 배운다

## 분석 데이터 모델과 트랜잭션 데이터 모델의 비교

- OLAP와 OLTP는 서로 다른 유형의 사용자를 지원하고, 다른 종류의 유스케이스를 구현하며 결국 다른 설계 원칙을 따른다
- OLTP는 시스템의 비즈니스 도메인에 속한 다양한 엔티티를 중심으로 구축되고 이들의 수명주기를 구현하며 상호작용을 조율한다
- OLAP는 실시간 데이터 처리 시스템에 대한 다양한 통찰을 제공하도록 고안됐다
    - 실시간 트랜잭션을 구현하는 대신 비즈니스 활동의 성과에 대한 통찰을 제공하는 것을 목표로 한다
    - 더 많은 비즈니스 가치를 얻도록 운영을 최적화 하는 방법을 제공하는 것이 목표!
    - 개별 비즈니스 엔티티를 무시하는 대신 팩트 테이블과 디멘전 테이블을 모델링하여 비즈니스 활동에 집중한다

### 팩트 테이블

- 팩트는 이미 발생한 비즈니스 활동을 나타낸다. 과거에 일어난 것에 대해 설명한다는 점에서 도메인 이벤트의 개념과 비슷하지만 과거 시제의 동사로 명명하도록 요구하지는 않는다
- 비즈니스 프로세스의 활동을 나타낸다
- 팩트 레코드는 절대 삭제되거나 수정되지 않는다. 즉, 추가만 가능한 데이터다.
- OLAP와 OLTP의 또 다른 큰 차이점은 데이터의 세분화 정도다
    - OLTP는 비즈니스 트랜잭션을 다루기 위해 가장 정밀한 데이터가 필요
    - OLAP는 데이터를 취합하는 것이 다양한 유스케이스에 더 효과적이다

### 디멘전 테이블

- 팩트가 비즈니스 절차나 동작을 표현한다면 디멘전은 팩트를 묘사한다
- 팩트의 속성을 설명하도록 고안되어 팩트 테이블에 있는 외부 키로 디멘전 테이블을 참조한다
- 디멘전으로 모델링된 속성은 다양한 팩트 레코드를 넘나들며 반복되는 모든 측정 또는 데이터이므로 단일 칼럼에는 맞지 않는다
- 분석 시스템에서 유연한 질의를 지원하기 위해 고도로 정규화 되어 있다

### 분석 모델

- 팩트와 디멘전의 관계가 다대일인 경우 스타 스키마로 표현할 수 있다
    - 여기서 단일 팩트의 외부 키들은 각기 하나의 디멘전 레코드를 가리킨다
- 각 디멘전을 더 작은 디멘전으로 정규화하기 위해 스노플레이크 스키마를 사용할 수 있다

---

## 분석 데이터 관리 플랫폼

- 데이터를 생성하고 분석 데이터를 제공하는 데이터 관리 아키텍처에 대해 논의해보자
- 데이터 웨어하우스와 데이터 레이크, 두 개의 일반적인 분석 데이터 아키텍처에 대해 논의해보자

### 데이터 웨어하우스

- 비교적 간단하다
- 기업의 모든 실시간 데이터 처리 시스템에서 데이터를 추출해 분석 모델로 변환한 후에 분석 지향 데이터베이스에 적재한다. 이 DB가 바로 데이터 웨어하우스다.
- 데이터 관리 아키텍처는 기본적으로 ETL 스크립트를 기반으로 한다
    - 데이터는 실시간 데이터 처리 데이터베이스, 스트림 이벤트, 로그 등의 다양한 원천에서 수집된다
    - 변환 단계에서 민감한 데이터를 지우고, 중복 레코드를 삭제하는 등 추가적인 작업이 포함될 수 있다
- 모든 상황을 아우르는 모델을 구축하는 것의 어려운 점은 데이터 마트를 사용해 부분적으로 해결가능하다
    - 데이터 마트는 단일 비즈니스 부서의 분석과 같이 잘 정의된 분석 요구사항에 관련된 데이터를 저장하는 일종의 DB다
- 또 다른 어려운 점은 ETL 프로세스가 OLAP와 OLTP 시스템 간에 강력한 결합을 만든다는 것이다

### 데이터 레이크

- 실시간 데이터 처리 시스템의 데이터를 유입하고 분석 모델로 변환하는 동일한 개념에 기반하지만 개념적인 차이가 있다
- OLTP로부터 데이터를 받는데 이를 바로 분석 모델로 변환하는 대신 원본형태로 보관한다
    - 원본 데이터는 데이터 분석의 요건에 맞지 않기에 데이터 레이크의 데이터를 이해하고 분석 모델을 생성하는 ETL 스크립트를 구현해 데이터 웨어하우스에 제공해야 한다
- 변환이 나중에 이뤄지므로 여러가지 ETL 스크립트를 구현해 다양한 버전의 분석 모델을 제공할 수 있다
- 유입되는 데이터에 스키마를 강제하지 않으며 수신 데이터의 품질을 제어하지 않아 특정 규모 이상이 되면 혼란스러워진다

### 데이터 웨어하우스와 데이터 레이크 아키텍처의 도전과제

- 분석을 위한 더 많은 데이터를 유입하면 조직은 더 많은 통찰을 얻는다는 가정에 기반하지만 ‘방대한 규묘’에 대한 무게로 인해 유명무실해지는 경향이 있다
- 모델링 관점에서 보면 두 아키텍처 모두 OLTP 시스템의 경계를 침범해 구현 상세에 대한 의존성을 생성한다

---

## 데이터 메시

- 분석 데이터를 위한 도메인 주도 설계라 볼 수 있다
- 분석 데이터에 대한 모델과 소유 경계를 정의하고 프로젝션한다
- 도메인 기준의 데이터 분리, 제품 관점에서 데이터 다루기, 자율성 활성화, 에코시스템 구축의 네 가지 핵심 원칙을 기반으로 한다

### 도메인 기준의 데이터 분리

- 결과 분석 모델은 전사적 실시간 데이터 모델과 정확하게 같은 이유로 효과적이지 못하며 모든 시스템의 데이터를 수집해서 하나의 장소에 넣으면 다양한 데이터 요소의 소유권 경계가 흐려진다 (경계를 명확히 하는게 데이터 메시 아키텍처라는 걸 유추할 수 있음!)
- 데이터 메시 아키텍처는 모놀리식 분석 모델을 구축하는 대신 원천 데이터에 분석 모델을 일치시켜서 데이터를 사용하므로 여러 분석 모델을 사용할 수 있다
- 분석 모델의 소유권 경계를 자연스럽게 BC의 경계와 일치시킨다

### 제품 관점에서 데이터 다루기

- 분석 데이터를 제일 중요하게 다뤄야 한다
- BC가 잘 정의된 출력포트를 통해 분석 데이터를 제공한다
- 분석 데이터는 통상적인 퍼블릭 API와 동일하게 취급돼야 한다
    - 필요한 엔드포인트인 데이터 출력 포트를 쉽게 찾을 수 있어야 한다
    - 분석 엔드포인트는 제공하는 데이터와 형식을 설명하는 잘 정의된 스키마를 가져야 한다
    - 분석 데이터는 신뢰할 수 있어야 하고 다른 API와 마찬가지로 서비스 수준 계약을 정의하고 모니터링 해야 한다
    - 분석 모델은 일반적인 API처럼 버전 관리를 하고 그에 따라 모델에서 연동을 망가뜨리는 변경을 관리해야 한다
- 사용자의 요구를 반영해야 한다
- 데이터 메시는 데이터 품질에 대한 책임이 가장 중요한 관심사다
- 사용자마다 여러 형태의 분석 데이터가 필요할 수 있다
    - 결국, 사용자의 요구사항을 충족하는 여러 형태의 데이터를 제공하도록 다양한 언어를 제공해야 한다

### 자율성 활성화

- 데이터 제품은 상호운영이 가능해야 한다
- 각 팀은 자신의 데이터 제품을 만들 수 있고 다른 팀에서 제공하는 제품도 사용할 수 있어야 하기에 상호운용이 가능한 데이터 제품의 구축, 실행, 유지보수의 복잡성을 추상화할 필요가 있다
    - 고로, 전담 데이터 인프라스트럭처 플랫폼 팀이 필요하다

### 에코시스템 구축

- 데이터 메시 시스템을 만드는 마지막 단계는 분석 데이터 도메인 관점에서 상호운영과 에코시스템을 가능하게 할 연합 거버넌스 기구를 임명하는 것이다
    - BC의 데이터 및 제품 소유자, 데이터 인프라스트럭처 플랫폼 팀의 대표로 구성되는 그룹
- 거버넌스 그룹은 사용운용이 가능한 정상적인 에코시스템을 보장하는 규칙을 정의할 책임이 있다
    - 이 규칙은 모든 데이터 제품과 그 인터페이스에 적용돼야 하고 거버넌스 그룹은 전사적으로 이 규칙을 따르도록 보장할 책임이 있다

### 데이터 메시와 도메인 주도 설계를 엮기

- 데이터 메시 아키텍처가 기반으로 하는 네 가지 원칙이 있다
    - 유비쿼터스 언어와 결과 도메인 지식은 분석 모델 설계를 위한 필수 요소다
    - 자신의 실시간 데이터 모델과 다른 모델로 BC 데이터를 노출하는 것은 오픈 호스트 패턴이다
    - CQRS 패턴은 동일한 데이터에 대한 여러 모델을 쉽게 생성하게 해준다
    - 데이터 메시 아키텍처는 분석 유스케이스를 구현하기 위해 다양한 BC의 모델을 묶기에 OLTP를 위한 BC의 연동 패턴은 분석 모델에도 적용된다
        - 서로 다른 제품을 담당하는 두 팀은 파트너십 패턴을 적용해 각자의 분석 모델을 발전시킬 수 있다
        - 효과가 없는 분석 모델로부터 스스로를 보호하기 위해 ACL를 구현할 수 있으며, 팀이 분리형 노선 패턴을 선택해 분석 모델의 구현을 중복해서 만들 수도 있다