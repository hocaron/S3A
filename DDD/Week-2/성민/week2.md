# 03. 도메인 복잡성 관리

조직 규모에 따라 도메인 전문가의 멘탈 모델은 일관성이 없을 수 있다. 같은 비즈니스 도메인에서도 도메인 전문가마다 서로 다른 모델을 사용할 수 있다.

### 일관성 없는 모델

- 예시로 ‘리드’라는 워딩은 마케팅 부서와 영업 부서에서 다른 의미로 사용될 수 있다.
- 이러한 모호성은 개인간의 의사소통에서는 큰 문제가 되지 않는다.
  - 사람들이 서로 상호작용하면서 정확한 의미를 추론하는 것은 쉽다.
- but, 다양한 비즈니스 도메인 모델을 SW로 표현하는 것은 어렵다.
  - 소스코드는 모호성에 대처하지 못한다.
  - 영업 부서의 복잡한 모델을 마케팅 부서에 적용하면 필요하지 않은 곳에서 복잡성을 키우게 될 것이다.
  - 반대로 마케팅 부서의 간단한 모델에 따라 영어 모델을 단순화하려고 하면 영업 프로세스를 관리하기에는 너무 단순하다.

이 딜레마를 어떻게 해결할까?

→ 전통적인 솔루션으로는 모든 종류의 문제에 사용할 수 있는 단일 모델을 설계하는 것이다.

> ‘이것저것 다 잘하는 사람은 단 한 분야에서도 달인이 될 수 없다.’

- 전사적 엔티티 관계 다이어그램 같이 설계한 모델은 결국에는 소용이 없다.
  - 관련 없는 세부사항을 필터링하는 복잡성, 필요한 것을 찾는 복잡성, 가장 중요하게는 데이터를 일관된 상태로 유지해야 하는 복잡성에 직면하게 된다.

또 다른 솔루션은 ‘마케팅 리드’와 ‘영업 리드’와 같이 문맥상 정의에 문제가 있는 용어 앞에 접두사를 추가하는 것이다.

- 인지 부하를 유발한다.
  - 각 모델을 언제 사용해야 할까? 충돌하는 모델을 계속해서 구현할수록 실수하기 쉽다.
- 모델의 구현이 유비쿼터스 언어와 일치하지 않는다.
  - 사람들은 대화에 접두사를 사용하지 않는다. 추가 정보가 없어도 대화의 맥락에 의존해 소통할 수 있어야 한다.

이러한 시나리오를 다루기 위한 **바운디드 컨텍스트**를 알아보자.

### 바운디드 컨텍스트란 무엇인가?

- 유비쿼터스 언어를 여러 개의 작은 언어로 나눈 다음 각 언어를 적용할 수 있는 명시적인 바운디드 컨텍스트에 할당하면 된다.
  - 마케팅과 영업에서의 리드는 두 가지 바운디드 컨텍스트로 식별할 수 있다.
  - 각 바운디드 컨텍스트에서 단일 의미를 갖는 한, 세분화된 유비쿼터스 언어 각각은 일관성을 띠며 도메인 전문가의 멘탈 모델을 따를 수 있다.
- 용어 충돌과 암시적 컨텍스트는 적당한 규모의 모든 비즈니스에는 내재된 부분이다.
  - 이 때, 바운디드 컨텍스트 패턴을 사용하면 명시적이고 중요한 비즈니스 도메인의 요소로 모델링할 수 있다.

### 모델 경계

- 모델은 경계없이 존재할 수 없다.
  - 각 지도는 항공, 해상 등 특정 컨텍스트가 있다.
    - 특정 목적 범위 내에서만 유용하고 일관성이 있다.
- 하나의 바운디드 컨텍스트의 유비쿼터스 언어는 다른 컨텍스트 범위에는 완전히 관련이 없다.
  - 유비쿼터스 언어에 대한 것들은 해당 바운디드 컨텍스트 내에서만 일관성이 있다.

### 정제된 유비쿼터스 언어

- 유비쿼터스 언어는 명시적으로 적용 가능한 컨텍스트 없이 정의하거나 사용할 수 없다.

### 바운디드 컨텍스트의 범위

- 유비쿼터스 언어의 범위(바운디드 컨텍스트)를 정의하는 것은 전략적인 설계 의사결정이다.
  - 크기 자체는 의사결정의 요소가 아니다.
  - 언어의 경계가 넓을수록 일관성을 유지하기가 어렵다.
  - 언어의 경계가 좁을수록 설계를 통합하는 오버헤드가 커진다.
- 큰 바운디드 컨텍스트에서 좁은 바운디드 컨텍스를 나누는 이유
  - 새로운 소프트웨어 엔지니어링 팀을 구성하거나 시스템의 일부 비기능 요구사항을 해결하는 것이 포함된다.
  - 바운디드 컨텍스트의 나머지 기능과 독립적으로 확장할 수 있기 때문이다.

## < 바운디드 컨텍스트 대 하위 도메인 >

### 하위 도메인

- 하위 도메인은 상호 관련된 유스케이스 집합과 유사핟,
  - 유스케이스는 비즈니스 도메인과 시스템 요구사항에 따라 정의된다.
  - SW엔지니어는 요구사항을 정의하지 않는다. 비즈니스가 담당한다.
  - SW엔지니어는 하위 도메인을 식별하기 위해 비즈니스 도메인을 분석한다.

### 바운디드 컨텍스트

- SW엔지니어에 의해 설계된다.
  - 비즈니스 도메인을 더 작고 관리 가능한 문제 도메인으로 어떻게 나눌지 정한다.

### 하위 도메인과 바운디드 컨텍스트 사이의 상호작용

- 단일 모델이 전체 비즈니스 도메인에 적용이 될 수 있다.
  - 소규모 시스템에서 효과적일 수 있다.
- 중요한 것은 하위 도메인은 발견하고 바운디드 컨텍스트는 설계한다는 점이다.
- 모델은 특정 문제를 해결하기 위해 존재한다. 어떤 경우에는 같은 개념의 여러 모델을 동시에 사용하여 다른 문제를 해결하는데 도움이 될 수 있다.
  - 바운디드 컨텍스트와 하위 도메인의 설계가 1:1일 때는 유연성이 떨어지게 된다.

## <경계>

바운디드 컨텍스츠 패턴은 물리적 경계와 소유권 경계를 규정하기 위한 도메인 주도 설계 도구다.

### 물리적 경계

- 바운디드 컨텍스트는 모델 경계뿐만 아니라 이를 구현하는 시스템의 물리적 경계 역할도 한다.
- 각 바운디드 컨텍스트는 개별 서비스/프로젝트로 구현되어야 한다.
  - 구현, 진화, 버전 관리를 독립적으로 해야 한다.
- 바운디드 컨텍스트는 여러 하위 도메인을 포함할 수 있다.
  - 바운디드 컨텍스트는 물리적 경계고, 하위 도메인은 논리적 경계다. 논리적 경계는 프로그래밍 언어의 종류에 따라 네임스페이스나 모듈, 패키지 같은 다른 이름을 갖는다(?)

### 소유권 경계

- 팀 간의 작업 분배는 바운디드 컨텍스트 패턴을 사용하여 내릴 수 있는 또 다른 전략적 의사결정이다.
- 바운디드 컨텍스트는 한 팀에서만 구현, 발전, 유지 관리해야 한다.
  - but, 서로 다른 바운디드 컨텍스트로 분리된 모델과 시스템을 명시적으로 연동하기 위한 통신 프로토콜을 정의해야 한다.

## <실생활의 바운디드 컨텍스트>

SW 엔지니어는 도메인 전문가가 다양한 비즈니스 엔티티와 프로세스에 대해 어떻게 생각하는 지 의식해야 한다.

### 시맨틱 도메인

- 시맨틱 도메인은 의미 영역과 해당 의미를 전달하기 위해 사용하는 단어 영역으로 구분한다.
  - 모니터, 포트, 프로세서는 SW와 HW 엔지니어링 시맨틱 도메인에서 서로 다른 의미를 가진다.

### 과학

- 모든 경우에 맞는 과학적 이론은 없다.
  - (바운디드) 컨텍스트 안에서 유용하다.

# 04. 바운디드 컨텍스트 연동

- 바운디드 컨텍스트의 모델은 서로 독립적으로 발전하고 구현될 수 있지만, 바운디드 컨텍스트 자체는 독립적이지 않다. 시스템의 요소가 전체의 목적을 달성하기 위해 상호작용 하듯이, 바운디드 컨텍스트도 상호작용해야 한다. 결국 바운디드 컨텍스트 사이에는 항상 접점이 있는데 이것을 **컨트랙트**라고 한다.
- 각 컨트랙트는 하나 이상의 당사자에 영향을 끼치므로 서로 조율해서 컨트랙트를 정의해야 한다.
- 바운디드 컨텍스트가 다르면 사용하는 유비쿼터스 언어도 다른다. 연동이 필요할 경우에는 어떤 언어를 사용해야 할까?

## <협력형 패턴 그룹>

협력형 그룹의 패턴의 적합한 요건은 팀의 커뮤니케이션과 협업의 수준에 있다.

### 파트너십 패턴

- 바운디드 컨텍스트 간의 연동은 애드혹(ad-hoc) 방식으로 조정한다.
  - 한 팀은 다른 팀에게 API의 변경을 알리고 다른 팀은 충돌 없이 이를 받아들인다.
- 연동의 조정은 양방향이다.
  - 어떤 팀도 컨트랙트를 정의하는 데 쓰는 언어를 강요하지 않는다.
  - 연동의 문제를 해결하는 데 협력하고 서로 방해하지 않는다.
- 팀 간의 잦은 동기화가 필수다.
  - 커뮤니케이션의 어려움이 있는 상황에서는 적합하지 않을 수 있다.

### 공유 커널 패턴

- 공유 커널과 같은 공유 모델은 모든 바운디드 컨텍스트의 필요에 따라 설계된다.
- 일관성을 항상 유지해야 한다.

### 공유 범위

- 겹치는 형태의 모델은 해당되는 바운디드 컨텍스트의 수명주기도 엮이게 한다.
- 변경의 연쇄 영향을 최소화하기 위해 양쪽의 겹치는 모델을 제한해서 바운디드 컨텍스트에서 공통으로 구현돼야 하는 모델의 일부분만 노출해야 한다.

### 구현

- 공유 커널은 소스코드의 모든 변경이 이를 사용하는 모든 바운디드 컨텍스트에 즉시 반영되도록 구현된다.
  - 어떤 방식이든 공유 커널에 대한 변경이 생길 때마다 영향을 받는 모든 바운디드 컨텍스트와 연동 테스트를 수행해야 한다.

### 공유 커널을 사용해야 하는 경우

- 중복 비용이 조율 비용보다 클 경우에만 적용해야 한다.
  - 두 바운디드 컨텍스트가 공유하는 코드베이스에 대한 변경을 조율하려는 노력보다 공유하는 모델에 대한 변경을 통합할 때 드는 노력이 더 클 경우에 적용한다.
- 변경이 잦을수록 통합 비용은 높아진다.
- 공유 커널을 사용하는 것이 단일 팀 원칙을 위반한다. 그래서 명분이 필요하다.(실용적인 예외)
- 레거시 시스템을 점진적으로 현대화할 경우에 쓰인다.
  - 시스템을 서서히 바운디드 컨텍스트로 분해해서 공유 코드베이스로 만드는 것이 실용적인 중간 솔루션이 될 수 있다.
- 바운디드 컨텍스트를 연동하면 시간이 흐르면서 경게가 희미해질 수 있다. 이 경우에 바운디드 컨텍스트의 연동 컨트랙트를 명시적으로 정의하는 데 공유 커널을 사용할 수 있다.

## <사용자-제공자 패턴 그룹>

- 제공자는 사용자에게 서비스를 제공한다.
  - 제공자는 업스트림, 사용자는 다운스트림이다.
- 서로 독립적으로 성공할 수 있다.
  - but, 대부분의 경우 업스트림 또는 다운스트림의 팀이 연동 컨트랙트를 주도하는 권력의 불균형이 존재한다.

### 순응주의자 패턴

- 다운 스트림 팀이 업 스트림 팀의 모델을 받아들이는 바운디드 컨텍스트의 관계
- 힘의 균형이 서비스를 제공하는 업스트림에 있는 경우.
- 사용자의 요구를 지원해야할 동기가 없는 경우가 그렇다.

### 충돌 방지 계층 패턴

- 다운스트림 바운디드 컨텍스트가 순응하지 않는 경우 충돌 방지 계층을 통해 업스트림 바운디드 컨텍스트의 모델을 스스로의 필요에 맞게 가공할 수 있다.
- 충돌 방지 계층은 다음 사례와 같이 제공자의 모델을 따르는 것을 원치 않거나 순응에 필요한 노력이 가치가 없을 경우를 다룬다.
  - 다운 스트림 바운디드 컨텍스트가 핵심 하위 도메인을 포함할 경우
    - 각별한 주의가 필요하다. 제공자의 모델이 자칫 문제 도메인에 대한 모델링을 방해할 수 있다.(?)
  - 업스트림 모델이 사용자의 요건에 비효율적이거나 불편한 경우
    - 바운디드 컨텍스트가 혼란에 순응하면 위험에 빠진다. 이런 경우는 레거시 시스템과 연동할 때 종종 발생한다.
  - 제공자가 컨트랙트를 자주 변경하는 경우
    - 사용자는 잦은 변경으로부터 모델을 보호하기 원한다. 충돌 방지 계층이 있으면 제공 모델의 변경은 변환 장치에만 영향을 미친다.
- 다운스트림 사용자가 제공자의 모델을 변환하면 자신의 바운디드 컨텍스트와 상관없는 외부의 개념으로부터 다운스트림 사용자를 안전하게 보호할 수 있다.

### 오픈 호스트 서비스 패턴

- 힘이 사용자 측에 있을 경우를 처리한다.
- 구현 모델의 변경으로부터 사용자를 보호하기 위해 업스트림 제공자는 퍼블릭 인터페이스와 구현 모델을 분리한다.
  - 외부에 제공되는 퍼블릭 모델과 그 내부 구현을 다른 속도로 발전시킬 수 있다.
  - 퍼블릭 인터페이스는 자신의 유비쿼터스 언어를 따르는 대신, 연동 지향 언어를 통해 사용자에게 더 편한 프로토콜을 노출하려 한다.
  - 위와 같은 퍼블릭 프로토콜을 공표된 언어라고 한다.
  - 업스트림 바운디드 컨텍스트는 이미 공표된 언어의 여러 버전을 동시에 노출할 수 있어서 사용자가 점진적으로 새로운 버전으로 이관할 수 있게 한다.
- 오픈 호스트 서비스 패턴은 충돌 방지 계층 패턴의 반대다.
  - 즉, 사용자 대신 제공자가 내부 모델 번역을 구현한다.

## <분리형 노선>

분리형 노선 패턴에는 팀에 협업 의지가 없거나 협업할 수 없는 경우에 적용된다. 다양한 이유가 있을 것이다.

### 커뮤니케이션 이슈

- 팀이 협업과 합의에 어려움을 겪고 있다면 여러 바운디드 컨텍스트 내에서 기능을 중복해서 가져가고 각자의 길을 가는 것이 더 효과적이다.

### 일반 하위 도메인

- 중복된 하위 도메인의 특성도 협업 없이 분리된 길을 가야 하는 이유가 될 수 있다.
  - 일반 하위 도메인이 일반 솔루션과 연동하는 것이 쉽다면 각자 연동하는 것이 더 비용 효과적일 수 있다.
    - ex. 로깅 프레임워크

### 모델의 차이

- 바운디드 컨텍스트 모델 간의 차이도 협업 없이 분리된 길을 가야하는 이유가 될 수 있다.
  - 순응 주의자 관계가 불가능하고 충돌 방지 계층을 구현하는 것도 기능 중복보다 비용이 더 클 수 있다.

## <컨텍스트 맵>

컨텍스트 맵은 바운디드 컨텍스트와의 연동을 시각적으로 표현한다. (거시적 설계 관점, 커뮤티케이션 패턴, 조직적 문제 등)

### 유지보수

- 컨텍스트 맵은 프로젝트 초기부터 도입해서 새로운 바운디드 컨텍스트와 기존 요소에 대한 수정을 반영하는 것이 이상적이다.

### 한계

- 여러 하위 도메인에 걸친 시스템의 바운디드 컨텍스트에는 작동하는 여러 연동 패턴이 있을 수 있어서 컨텍스트 맵을 작성하는 것은 어려운 작업이다.
