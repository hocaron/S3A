# 09. 커뮤니케이션 패턴
> 단일 컴포넌트의 경계를 넘어 시스템 요소 전반의 커뮤니케이션 흐름을 구성하는 패턴에 대해 논의한다.
## 모델 변환
- 바운디드 컨텍스트는 유비쿼터스 언어 모델의 경계다
- 두 컨텍스트의 통합 문제는 팀간의 커뮤니케이션을 통해 해결하거나, 공유 커널을 통해 해결한다.
- 사용자(다운스트림)-제공자(업스트림) 관계는 한쪽이 권력을 갖게되는데, 모델을 서로 공유할 수 없는 경우 변환이 필요하다.
  - 한쪽 혹은 양쪽 모두에서 처리 가능. 다운스트림-충돌방치계층(ACL), 업스트림-오픈호스트서비스(OHS)
- 모델의 변환 로직은 stateful 하거나 stateless할 수 있다.
### stateless 모델 변환
- 이 변환의 책임이 있는 컨텍스트에서는 proxy design pattern을 구현한다.
- 프록시는 컨텍스트가 동기 혹으 비동기로 통신하는 지에 따라 구현법이 다르다.
- 동기
  - 바운디드 컨텍스트에 변환 로직을 포함한다.(사진)
  - 경우에 따라 변환 로직을 API Gateway와 같은 외부 컴포넌트로 넘길 수 있다.
    - OHS를 구현하는 제공자의 경우, API Gateway는 내부 모델을 통합에 최적화된 공용 언어로 변환한다.
    - ACL을 구현하는 사용자의 경우, 여러 사용처(컨텍스트)에서 통합된 API Gateway를 사용할 수 있다. -> interchage context 라고도 부른다.
- 비동기
  - 이 변환의 책임이 있는 컨텍스트에서는 message proxy 를 구현한다.
  - 메시지 변환 외에도 관심있는 메시지만 필터링해 노이즈를 줄일 수 있다.
  - OHS를 구현할 때엔 비동기식 모델 변환이 반드시 필요하다. -> 구현 상세를 더 잘 캡슐화 가능
### stateful 모델 변환
- 더 중요한 모델 변환의 경우 필요
- ex) 들어오는 데이터 집계해야할 때, 여러 요청을 통합해야할 때
## 애그리게이트 연동
- 어떻게 도메인 이벤트가 메시지 버스에 발행될까?
- 여러가지 장애 케이스로 도메인 이벤트의 발행이 보장되지 않을 수 있고, 이는 아웃박스 패턴을 사용해 해결 가능하다.
### 아웃박스
- 도메인 이벤트의 안정적 발행 보장
  - 업데이트된 애그리게이트 상태와 새 도메인 이벤트는 모두 동일한 원자성 트랜잭션으로 커밋
  - 메시지 릴레이는 데이터베이스에서 새로 커밋된 도메인 이벤트를 가져옴
  - 릴레이는 도메인 이벤트를 메시지 버스에 발행
  - 성공적으로 발행되면 데이터베이스에 발행 표시 혹은 삭제
- 메시지 발행 릴레이의 경우 pull(발행자 폴링) 혹은 push(트랜잭션 로그 추적)기반으로 새 도메인 이벤트를 가져올 수 있다.
- 아웃박스 패턴은 적어도 한 번은 메시지 전달을 보장한다는 점에 유의하자. -> 같은 메시지 재 발행 가능
### 사가
- 여러 애그리게이트에 걸쳐 있는 비즈니스 프로세스를 구현해야하는 경우
- 사가는 오래 지속되는 비즈니스 프로세스 => 시간 측면이 아니라 트랜잭션 측면에서.
- 사가는 관련 컴포넌트에서 발생하는 이벤트를 수신하고 다른 컴포넌트에 후속 커맨드를 실행한다.
- 상태 관리가 필요한 사가의 경우네 이벤트 소싱 애그리에트로 구현되어 수신도니 이벤트와 실행된 커맨드의 전체 기록을 유지한다.
### 프로세스 관리자
- 사가 패턴은 단순하고 선형적인 흐름을 관리한다.
- 프로세스 관리자는 시퀀스의 상태를 유지하고 다음 처리 단계를 결정하는 중앙 처리 장치로 정의
- 프로세스 관리자는 종종 상태 기반 또는 이벤트 소싱의 애그리게이트로 구현된다
## 결론
- OHS, ACL을 구현하는데 사용할 수 있는 모델 변환 패턴을 배웠다.
- 아웃박스와 사가패턴은 모두 도메인 이벤트에 대한 비동기식 반응과 커맨드 실행에 의존한다.
- - -
# Part 03. 도메인 주도 설계 적용 실무
> (드디어) 이론이 아닌 실무를 다룬다.
- - -
# 10. 휴리스틱 설계
> 다양한 소프트웨어 설계 의사결정을 하는 분석도구를 사용을 위한 휴리스틱을 배운다.
## 휴리스틱
- 당면한 목적에 충분할 만큼의 경험에 기반한 규칙
## 바운디드 컨텍스트
- 바운디드 컨텍스트의 최적의 크기는 무엇일까?
- 원하는 크기를 기준으로 경계를 구분하지 말고, 모델의 기능을 기준으로, 기능 크기 그대로 경계를 다루자.
- 변경이 단일 바운디드 컨텍스트 범위 내에 있지 않다면 이는 경계의 설계가 효과적이지 않다는 신호.
- 변동성과 불확실성이 핵심 하위 도메인의 특성이다.
- 일반 하위 도메인과 지원 하위 도메인은 모두 정형화되어 있고 변동성이 훨씬 적다
- 바운디드 컨텍스트를 설계할 때는 경계를 넓게해서 시작하다 -> 필요에 따라 쪼갠다.
## 비즈니스 로직 구현 패턴
- 핵심 하위 도메인의 경쟁력은 반드시 기술적인 것이 아닐 수 있다는 점을 기억하자
## 아키텍처 패턴
- 조합은 각각 이렇게 어울린다.
  - 이벤트 소싱 도메인 모델 - CQRS
  - 도메인 모델 - 포트&어댑터
  - 액티브 레코드 패턴 - 서비스 계층이 있는 계층형 아키텍처
  - 트랜잭션 스크립트 패턴 - 최소한의 계층형
## 테스트 전략
### 피라미드형 테스트
- 단위 테스트 몰빵
- 에그리게이트와 벨류 오브젝트 도메인 모델 패턴 잘 지원
### 다이아몬드형 테스트
- 통합 테스트 몰빵
- 액티브 레코드 패턴에 잘 어울림
### 역전된 피라미드형 테스트
- 앤드투앤드 테스트 몰빵
- 트랜잭션 스크립트 패턴 잘 어울림
### 결론
- 고정된 규칙이 아닌 휴리스틱을 반복하는 것이 중요
- 더 중요한 것은 시간이 지나면서 과거의 의사결정이 여전히 유효한지 검증하는 것