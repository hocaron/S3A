# 성능과 최적화

## Intro
- 성능 분석은 경험주의와 인간 심리학이 어우러진 분야
  - 최적화는 옵션 조금씩 바꿔가면서 맞춰가는..
- 중요한 건 관측지표의 절대 수치, 엔드 유저 사용자 등이 수치를 어떻게 받아들이는가

## 1.1 자바 성능: 잘못된 방법
- 무조건 맞는 정답 X
- 이 책은 코드에 바로 써먹을 수 있는 성능 팁을 나열하지 않음. 목표를 달성하기 위한 여러가지 단면을 조명
  - 소프트웨어 수명 주기의 성능 방법론
  - 성능과 관련된 테스트 이론
  - 측정, 통계, 툴링
  - 시스템, 데이터 분석 스킬
  - 서브시스템과 메커니즘
- 최적화 하는 기법은 트레이드 오프가 있음
- 결론: 휴리스틱, 노가다~. 기본 원리를 알고 분석해보고 분석 결과 이러니 이걸 고치면 이렇게되지 않을까? 하면서 조금씩 건드려보는..

## 1.2 자바 성능 개요
- 과거에는 생산성을 대가로 어느정도 성능 희생
- gc 같은 실용적인 서브시스템
- `정규 분포를 따르지 않는 경우가~~` -> 대부분의 경우를 보지 말고 한두가지 툭툭 튀는 아웃라이어를 주목하자
- 성능 측정 행위도 오버헤드를 일으키고 세심한 방법이 필요하다
  - 결국 FM의 정답을 찾으려하지말고 노가다를 해라~

## 1.3 성능은 실험과학이다
- jvm 성능 튜닝은 기술, 방법론, 정량적 측정값, 툴을 망라한 개념
- 목표는 "시스템소유자/유저가 추구하는 측정결과를 얻는 것"
- 실험과학
  - 원하는 결과를 정의한다 (api 응답이 xx ms인데 타임아웃을 줄잉자)
  - 기존 시스템을 측정한다 (gc 시간이 100ms 이상)
  - 요건을 충족시키려면 무슨 일을 해야 할지 정한다 (MaxGCPauseMillis를 줄이자.. latency와 throughput의 트레이드오프)
  - 개선 활동을 추진한다
  - 다시 테스트한다
  - 목표가 달성되었는지 판단한다

## 1.4 성능 분류

### 1.4.1 처리율
- 수행 가능한 작업 비율(일정 시간동안 완료한 작업 단위 수)
- 의미있는 지표가 되려면 기준 플랫폼, 수행하는 트랜잭션, 워크로드 등을 동일하게 유지

### 1.4.2 지연
- 하나의 트랜잭션을 처리하는데 걸리는 시간

### 1.4.3 용량
- 시스템이 동시 처리 가능한 트랜잭션 개수(병렬성의 총량)
- 동시 부하가 증가할 수록 처리율이 영향을 받으므로 용량은 어떤 처리율 또는 지연을 전제로 가능한 걸 표시

### 1.4.4 사용률
- cpu utilization

### 1.4.5 효율
- 처리율을 리소스 사용률로 나눈 값

### 1.4.6 확장성
- 리소스 추가에 따른 처리율 변화
- 선형 확장 (N)을 달성하기 어려움(여러가지 영향을 받기 때문)

### 1.4.7 저하
- 시스템 사용률이 증가하면 처리율이 더는 늘어나지 않는, 지연이 증가하는 양상

### 1.4.8 측정값 사이의 연관관계
- 다양한 성능 측정값들은 어떤 식으로든 서로 연결되어있음
- 시스템 부하가 증가하면 사용률이 달라지만 시스템을 많이 사용하지 않을때는 변화 없을 수 있음
- 부하는 늘었는데 리소스는 그대로라면 지연이 저하

## 1.5 성능 그래프 읽기
- 부하가 증가하면서 그래프가 꺾이는 현상: 성능 엘보
- 선형적으로 확장되는 경우는 세션 어피니티가 없는 무상태(요즘은 대부분~)
- 피보나치 그래프를 보면 90초 쯤에 갑자기 할당률이 뚝떨어짐
  - gc가 발생했고 gc 스레드들이 cpu 경합을 벌임.
- 초당 트랜잭션 수가 늘어나면서 지연이 급등하면 리소스 누수(메모리 릭)을 의심

